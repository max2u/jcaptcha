<?xml version="1.0"?>
<document>

    <meta name="keyword" content="captcha, java, module,struts, jcaptcha"/>

    <body>

        <section name="Introduction">
            <p>
 This document is a tutorial that demonstrates how to integrate
 JCaptcha with a Struts based Web application using the Jcaptcha Struts module.
                <br/>It Uses
                <a href="http://www.rollerweblogger.org/">the Roller Weblogger</a> as the base web application to captcha-ize.
            </p>

            <p>This tutorial is devided into TODO Steps.</p>
            <ul>
                <li>Step 1 : Prerequisites </li>
                <li>Step 2 : install and configure the jcaptcha struts plugin</li>
                <li>Step 3 : Indentify the to be captchai-zed page flow</li>
                <li>Step 4 : Short cut the identified actions with captcha action</li>
                <li>Step 5 : Modify the input page</li>
            </ul>
        </section>


        <section name="Prerequisites">
            <p>
        It is assume that you have a roller web application instance running.
         See
                <a href="http://www.rollerweblogger.org/wiki/Wiki.jsp?page=InstallationGuide">Roller installation guide</a> to achieve this.
            </p>
        </section>


        <section name="Install the jcaptcha struts plugin">
            <p>

                <ul>

                    <li>Copy the jcaptcha jar to the WEB-INF/lib dir of the roller web-app : jcaptcha-${version}.jar</li>
                    <li>Add the folowing at the end of the struts config file</li>
                    <code>
                        <plug-in className="com.octo.captcha.module.struts.CaptchaServicePlugin"/>
                    </code>
                    (there's many settable property available, but none are required, this is detailed in the module documentation).
                    <li>Copy the jcaptcha taglib file into the WEB-INF/tlds folder of the roller webapp</li>

                    <li>Add the jcaptcha taglib to the web.xml config file of the roller webapp</li>
                    <code>

                        <taglib>
                            <taglib-uri>jcaptcha</taglib-uri>
                            <taglib-location>/WEB-INF/tlds/jcaptcha.tld</taglib-location>
                        </taglib>
                    </code>

                </ul>
            </p>
        </section>


        <section name="Indentify the to be captchai-zed page flow">
            <p>
We want to captcha-ize the comment page flow in order to avoid comment spam...
                <br/>
This page flow concerns the following elements in roller struts config file :
            </p>
            <code>
 ...


                <form-bean
                    name="commentFormEx"
                    type="org.roller.presentation.weblog.formbeans.CommentFormEx"
                    />

        ....

                <action
                    path="/comment"
                    type="org.roller.presentation.weblog.actions.CommentFormAction"
                    name="commentFormEx"
                    scope="session"
                    parameter="method"
                    unknown="false"
                    validate="true"
                    >

                </action>
...

            </code>
As we can see here, there is one action :
            <b>comment.do</b> associed with one form
            <b>commentFormEx</b> with an entry path
            <b>comment.do</b> and an entry page
            <b>comment-form.jspf</b>


        </section>

        <section name="Short cut">
            <p>
So what we have to do next is to short cut this action (comment.do) to place a captcha verification action before calling the 'real' action.
                <br/>
                        In order to do it, we will
                <ul>
                    <li>
        create a new action called captchacomment that will execute the 'real' action.
                    </li>
                    <li>
 replace the 'real' action class and form in order to execute the capthca validation routine
                    </li>
                    <li>
 Finaly add the render challenge action.
                    </li>
                </ul>
The final configuration will look as follow :
                <code>

                    <action
                        path="/comment"
                        type="com.octo.captcha.module.struts.VerifyCaptchaChallengeAction"
                        name="commentFormEx"
                        scope="session"
                        parameter=""
                        unknown="false"
                        validate="true"
                        >
                        <forward
                            name="success"
                            path="/jcaptchacomment.do"/>
                        <forward
                            name="failure"
                            path="/comment.page"/>


                    </action>
                    <action
                        path="/jcaptchacomment"
                        type="org.roller.presentation.weblog.actions.CommentFormAction"
                        name="commentFormEx"
                        scope="session"
                        parameter="method"
                        unknown="false"
                        validate="true"
                        >


                    </action>


                    <action
                        path="/jcaptcha"
                        type="com.octo.captcha.module.struts.image.RenderImageCaptchaAction"
                        >


                    </action>


                </code>

            </p>
        </section>

        <section name="Modify the input jsp">
            <p>
                    <code>
                        <%@ page import="org.roller.pojos.WeblogEntryData" %>
                        <%@ page import="org.roller.pojos.WebsiteData" %>

                        <%-- Add the jcaptcha taglib--%>

                        <%@ taglib uri="jcaptcha" prefix="jcaptcha"%>
                        <%
                        RollerRequest rreq = RollerRequest.getRollerRequest(request);
                        WeblogEntryData entry = rreq.getWeblogEntry();
                        WebsiteData website = rreq.getRoller().getUserManager().retrieveWebsite(
                            entry.getWebsite().getId());
                        if (website.getAllowComments().booleanValue())
                        {
                        %>
                        <%-- Add the message tag--%>
                        <jcaptcha:message/>

                        <html:form action="/comment" method="post" focus="name" scope="session"
                            onsubmit="fixURL(this); return validateForm(this)">
                            <html:hidden property="entryId"/>

                        <%-- Add the question--%>

                        <jcaptcha:question/>

                        <%-- Add the image--%>

                        <img src="jcaptcha.do"/>
                        <%-- Add the input tag--%>

                        <input type="text"  name="jcaptcha_response" />



                            <input type="hidden" name="entryid" value='<%=request.getParameter("entryid")%>' />

                            <table cellspacing="0" cellpadding="1" border="0" width="95%">
                            <tr><th>Name:</th>
                                <td><html:text property="name" size="50" maxlength="255" /></td>
                            </tr>

                            <tr><th>Email:</th>
                                <td><html:text property="email" size="50" maxlength="255" /></td>
                            </tr>

                            <tr><th>URL:</th>
                                <td><html:text property="url" size="50" maxlength="255" /></td>
                            </tr>
                            <tr>
                                <td></td>
                                <td>
                                    <input type="checkbox" id="rememberInfo" name="rememberInfo" />
                                    <label for="rememberInfo">Remember Information?</label>
                                </td>
                            </tr>
                            <tr>
                                <td colspan="2" style="text-align: center; padding: 5px">
                                <span style="background: transparent; color: #999; float: right">
                                HTML Syntax:
                                <% if (escapeHtml) { %>
                                    <em style="color: red">Disabled</em>
                                <% } else { %>
                                    <strong style="color: green">Enabled</strong>
                                <% } %>
                                </span>
                                <span style="float: left; font-weight: bold">Comments:</span>
                                <br />
                                <html:textarea property="content" cols="50" rows="10" /><br />
                                </td>
                            </tr>
                            </table>

                            <!-- is this a publish or a preview -->
                            <input type="hidden" name="method" value="update" />

                            <table cellspacing="0" cellpadding="1" border="0" width="95%">
                            <tr>
                                <td align="left" nowrap="nowrap">
                                <input type="button" name="post" value="&nbsp;PREVIEW&nbsp;"
                                        onClick="this.form.method.value='preview';this.form.submit()" />

                                <input type="submit" name="post" value="&nbsp;POST&nbsp;" />
                                </td>
                                <td align="right">
                                <input type="button" onclick="window.close()" value="&nbsp;CANCEL&nbsp;" />
                                </td>
                            </tr>
                            </table>
                        </html:form>
                        <script type="text/javascript">
                        <!--
                        // populate the user's saved information
                        if (getCookie("commentAuthor")) {
                            var theForm = document.forms[0];
                            theForm.name.value = getCookie("commentAuthor");
                            theForm.email.value = getCookie("commentEmail");
                            theForm.url.value = getCookie("commentUrl");
                            theForm.rememberInfo.checked = true;
                            theForm.content.focus();
                        }

                        function fixURL(theForm) {
                            if (theForm.url.value != "" &&
                                theForm.url.value.indexOf("http://") == -1) { //prepend http://
                                theForm.url.value = "http://"+theForm.url.value;
                            }
                            saveSettings(theForm);
                        }

                        function saveSettings(theForm) {
                            if (theForm.rememberInfo.checked) {
                                rememberUser(theForm);
                            } else {
                                forgetUser(theForm);
                            }
                        }

                        function validateForm(theForm) {
                            if (theForm.content.value == "") {
                                alert("Please enter a comment.");
                                theForm.content.focus();
                                return false;
                            }
                        }
                        //-->
                        </script>

                        <%
                        } else {
                        %>
                        <span class="warning">Comments have been disabled</span>
                        <%
                        }
                        %>
                 
                    </code>

            </p>
        </section>

    </body>
</document>
